<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Open Software License (OSL 3.0)
 * that is bundled with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/osl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade the Bolt extension
 * to a newer versions in the future. If you wish to customize this extension
 * for your needs please refer to http://www.magento.com for more information.
 *
 * @category   Bolt
 * @package    Bolt_Boltpay
 * @copyright  Copyright (c) 2018 Bolt Financial, Inc (http://www.bolt.com)
 * @license    http://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */

/********************************************************************
 * Bolt replace button JavaScript / CSS that's added to the shopping cart page
 ********************************************************************/


if(!Mage::helper('boltpay')->canUseBolt($this->getQuote(), false)) return;

?>
<script>

    var onloadCallback = function(){

        /****************************************************************************************************
         * Finds and replaces specified buttons with Bolt checkout buttons. Runs internal function
         * on every 0.5 seconds up to 20 times. If no button was found for 10 seconds it clears the interlal
         ****************************************************************************************************/
        var replaceCheckout = function() {

            var replaceRetries  = 20;
            var replaceInterval = 500;


            // replaceable button selectors and types of Bolt buttons to replace them with
            var selectors = {
                ".block-cart .block-content .actions button.button" : "bolt-checkout-button with-cards bolt-multi-step-checkout forward-to-cart <?=$this->getTheme(); ?>"
            };

            var config_selectors = JSON.parse('<?=$this->getConfigSelectors();?>');

            for (var i = 0, length = config_selectors.length; i < length; i++ ) {

                var selector = config_selectors[i];
                selectors[selector] = "bolt-checkout-button with-cards bolt-multi-step-checkout " + selector.replace(/^[.#]*/, "").replace(/[.#]*$/, "") + "-<?=$this->getCssSuffix(); ?> <?=$this->getTheme(); ?>";
            }

            var tryInterval = setInterval(

                function() {

                    replaceRetries -= 1;
                    if (replaceRetries === 0) clearInterval(tryInterval);

                    var found_elements = false;

                    /*************************************************************
                     * Try to find all replaceable buttons in every iteration.
                     * Hide every button found and insert a Bolt button next to it.
                     *************************************************************/
                    for (var selector in selectors) {

                        if (selectors.hasOwnProperty(selector)) {

                            var elements = document.querySelectorAll(selector);

                            for (var i = 0, length = elements.length; i < length; i++ ) {

                                var element = elements[i];
                                found_elements = true;

                                element.style.display = "none";

                                var bolt_button =  document.createElement("div");
                                bolt_button.setAttribute("class",selectors[selector]);

                                element.parentNode.insertBefore(bolt_button, element);

                                if (element.parentNode.style.display === "") {
                                    element.parentNode.style.display = "block";
                                }
                            }
                        }
                    }

                    if (! found_elements) return;

					<?php if ($this->isBoltOnlyPayment()): ?>

                    var lis = document.querySelectorAll('ul.checkout-types li');

                    for (var i = 0, length = lis.length; i < length; i++) {
                        var li = lis[i];

                        if (li.style.display != "block")  li.style.display = "none";
                    }

                    var proceed_link = document.querySelectorAll('div.checkout_proceed_link a.button_link.checkout-proceed')[0];

                    if (proceed_link) {
                        proceed_link.text = proceed_link.text = "<?=$this->__('Proceed to Checkout');?>";
                    }

					<?php endif; ?>

                    // do nut run the replacement routine again
                    clearInterval(tryInterval);

                    // On every 50 ms check if the Bolt connect.js javascript is inserted
                    // by checking the BoltCheckout object existence. Clear the interval when
                    // BoltCheckout is found. On products page the Bolt checkout button
                    // is set up to forward to the cart page. On cart page BoltCheckout.process is executed.
                    var processInterval = setInterval(
                        function() {

                            if (typeof BoltCheckout !== "undefined") {

                                clearInterval(processInterval);

                                // selector that indicates that forward to the cart
                                // functionality should be implemented, products page.
                                var forward_button = document.querySelectorAll('.forward-to-cart')[0];

                                if (forward_button) {

                                    var styleEl = document.createElement('style'), styleSheet;
                                    document.head.appendChild(styleEl);
                                    styleSheet = styleEl.sheet;
                                    styleSheet.insertRule("#bolt-modal-background { display:none; }", 0);

                                    forward_button.onclick = function(event){
                                        event.preventDefault();
                                        event.stopPropagation();
                                        location.href = '<?=$this->getCartURL();?>';
                                    };
                                } else {
                                    /*****************************************************************
                                     * Creating the order at Bolt end, if applicable (cart not empty).
                                     * Generating BoltCheckout code.
                                     *****************************************************************/
									<?=$this->getCartDataJs(); ?>
                                }
                            }

                        }, 50
                    );

                }, replaceInterval);
        };

        replaceCheckout();

    };

    if (window.addEventListener) {
        window.addEventListener("load", onloadCallback, false);
    } else if (window.attachEvent) {
        window.attachEvent("onload", onloadCallback);
    } else {
        window.onload = onloadCallback;
    }

</script>

<style>
    <?=$this->getSelectorsCSS();?>
    <?=$this->getAdditionalCSS();?>
</style>
