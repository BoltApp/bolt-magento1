<?php
/**
 * Bolt magento plugin
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Open Software License (OSL 3.0)
 * that is bundled with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/osl-3.0.php
 *
 * @category   Bolt
 * @package    Bolt_Boltpay
 * @copyright  Copyright (c) 2019 Bolt Financial, Inc (https://www.bolt.com)
 * @license    http://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */

/* @var $this Bolt_Boltpay_Block_Catalog_Product_Boltpay */
?>
<?php if ($this->isEnabledProductPageCheckout()): ?>
    <?php if (!$this->isSupportedProductType()):?>
    <script type="text/javascript">
        var stateOld = {};
        var stateNew = {};
        
        var startBolt = function() {
            Object.assign(stateOld, spConfig.state);
            if (JSON.stringify(stateOld) == JSON.stringify(stateNew)) {
                return;
            }
            Object.assign(stateNew, spConfig.state);
            jQuery('#ppcBuyNow').show();
            jQuery('div.bolt-product-checkout-button').empty();
        }
        if (typeof spConfig != 'undefined' && typeof spConfig.configureObservers != 'undefined') {
            spConfig.configureObservers.push(startBolt);
        }

        var productPageCheckout = new VarienForm('product_addtocart_form');
        productPageCheckout.form.observe('change', function(){
            jQuery('#ppcBuyNow').show();
            jQuery('div.bolt-product-checkout-button').empty();
        });

        productPageCheckout.click = function() {
            if (this.validator.validate()) {
                jQuery('div#ppcBuyNow').addClass("disabledbutton");
                jQuery('div#ppcBuyNow span span').html('Processing...');
                var formData = new FormData(this.form);
                jQuery('#ajax_loader').show();
                try {
                    jQuery.ajax( {
                        url : "/boltpay/order/ppc",
                        dataType : 'json',
                        type : 'post',
                        cache: false,
                        processData: false,
                        contentType: false,
                        data : formData,
                        success : function(response) {
                            var token = response.token || "";
                            jQuery('#ppcBuyNow').hide();
                            BoltCheckout.configureProductCheckout({"orderToken": token}, {}, {});
                            jQuery('#ajax_loader').hide();
                            jQuery('div#ppcBuyNow').removeClass("disabledbutton");
                            jQuery('div#ppcBuyNow span span').html('Buy Now');
                        }
                    });
                } catch (e) {
                }
            }
        }.bind(productPageCheckout);
    </script>
    <?php else:?>
    <script type="text/javascript">
        jQuery('#qty').on('change', function() {
            jQuery('div.bolt-product-checkout-button').empty();
            jQuery('#ppcBuyNow').show();
            var productPageCheckout = new VarienForm('product_addtocart_form');
            var data = productPageCheckout.form.serialize();
            data += '&isAjax=1';
            try {
                jQuery.ajax( {
                    url : "/boltpay/order/ppc",
                    dataType : 'json',
                    type : 'post',
                    data : data,
                    success : function(response) {
                        var token = response.token || "";
                        BoltCheckout.configureProductCheckout({"orderToken": token, "autoStart": true}, {}, {});
                        jQuery('#ppcBuyNow').hide();
                    }
                });
            } catch (e) {
            }
        });
    </script>
    <?php endif;?>
<?php endif; ?>
