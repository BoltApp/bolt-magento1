version: 2.1
jobs:
  integration-tests:
    docker:
      - image: boltdev/m1-plugin-ci-php56-mage19:v5
        auth: 
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASS
# Use old version of selenium - latest version has issue with our test https://github.com/BoltApp/integration-tests/pull/1500
      - image: selenium/standalone-chrome:3.141.59-20200326
    steps:
      - checkout
      - run:
          name: Integration test
          command: |  
              MAGENTO_VERSION=magento-mirror-1.9.3.6 tests/scripts/setup_integration.sh
              echo "Running integraiton test"
              git clone git@github.com:BoltApp/integration-tests.git
              cd integration-tests
              git checkout expire-code
              npm install
              mkdir -p ./screenshots
              TEST_SUITE=checkout_full_magento1 JUNIT_REPORT_DIR=./test-results SCREENSHOT_DIR=./screenshots TEST_ENV=plugin_ci npm run test-retry-runner
      - run:
          command: |
            cat integration-tests/test_status.txt

            if [[ -f ".integration-tests/test-results/failedSpecs$CIRCLE_NODE_INDEX.json" ]]; then
              failed_files=$(cat ./test-results/failedSpecs$CIRCLE_NODE_INDEX.json | jq -r '.specs | join(" ")')
              echo "\n"
              echo "To re-run failed tests the command you want to run locally after setting the right env:"
              echo "npm run test-spec $failed_files"
            fi
          name: get results
          when: always
      - store_test_results:
          path: ./integration-tests/test-results
      - store_artifacts:
          path: ./integration-tests/screenshots
      - store_artifacts:
          path: ./integration-tests/test_status.txt

workflows:
  integration-tests:
    jobs:
    - integration-tests:  
        context: integration-tests-secrets
