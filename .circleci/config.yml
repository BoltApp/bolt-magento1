version: 2.1
jobs:
  integration-tests:
    docker:
      - image: boltdev/m1-plugin-ci-php56-mage19:v4
        auth: 
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASS
      - image: circleci/mysql:5.7
      - image: selenium/standalone-chrome
    steps:
      - checkout
      - run:
          name: Integration test
          command: |  
              MAGENTO_VERSION=magento-mirror-1.9.3.6 tests/scripts/setup_integration.sh
              echo "Running integraiton test"
              git clone git@github.com:BoltApp/integration-tests.git
              cd integration-tests
              git checkout m1_ci_2020
              npm install
              mkdir -p ./screenshots
              TEST_SUITE=checkout_full_magento1 JUNIT_REPORT_DIR=./test-results SCREENSHOT_DIR=./screenshots TEST_ENV=plugin_ci npm run test-retry-runner
      - store_test_results:
          path: ./integration-tests/test-results
      - store_artifacts:
          path: ./integration-tests/screenshots
      - run:
          name: Generate Report
          command: |
            cd integration-tests
            npm run generate-report
          when: always
      - store_artifacts:
          path: ./integration-tests/allure-report

workflows:
  integration-tests:
    jobs:
    - integration-tests:  
        context: integration-tests-secrets
